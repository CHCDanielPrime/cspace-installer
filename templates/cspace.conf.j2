upstream collectionspace {
	server localhost:8180;
}

{% if certbot_certs | length > 0 %}
server {
	listen 80;
	listen [::]:80;
	server_name {{ collectionspace_domain }};
	return 301 https://{{ collectionspace_domain }}$request_uri;
}
{% endif %}

server {
	server_name {{ collectionspace_domain }};
	charset utf-8;
{% if certbot_certs | length > 0 %}
	listen 443 ssl;
	listen [::]:443 ssl;
	ssl_certificate     /etc/letsencrypt/live/{{ collectionspace_domain }}/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/{{ collectionspace_domain }}/privkey.pem;
	ssl_protocols       TLSv1.1 TLSv1.2;
	ssl_ciphers         HIGH:!aNULL:!MD5;
{% else %}
	listen 80;
	listen [::]:80;
{% endif %}

	gzip              on;
	gzip_vary         on;
	gzip_proxied      any;
	gzip_comp_level   9;
	gzip_buffers      16 8k;
	gzip_http_version 1.1;
	gzip_min_length   256;
	gzip_types        text/plain text/css application/json application/javascript application/x-javascript text/xml application/xml application/xml+rss text/javascript application/vnd.ms-fontobject application/x-font-ttf font/opentype image/svg+xml image/x-icon;

	proxy_buffer_size       128k;
	proxy_buffers           4 256k;
	proxy_busy_buffers_size 256k;
	proxy_set_header        Host               $host;
	proxy_set_header        X-Forwarded-For    $proxy_add_x_forwarded_for;
	proxy_set_header        X-Forwarded-Host   $host;
	proxy_set_header        X-Forwarded-Server $host;
	proxy_set_header        X-Forwarded-Proto  $scheme;
	proxy_set_header        X-Real-IP          $remote_addr;

	location / {
		return 301 http://{{ collectionspace_domain }}/cspace/{{ collectionspace_tenant }}/login;
	}
	location /cspace-services {
		proxy_pass http://collectionspace;
	}
	location /cspace-ui/ {
		proxy_pass http://collectionspace;
	}
	location /cspace/{{ collectionspace_tenant }}/ {
		proxy_pass http://collectionspace;
	}
}
